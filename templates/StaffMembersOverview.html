<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Members Overview – RGSQ Staff</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Site CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

  <!-- Bootstrap Icons (for small icons on KPI cards) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    .page-title{
      background:#0861af;color:#fff;border-radius:10px;padding:.75rem 1rem;letter-spacing:.08rem
    }
    .kpi-card .kpi-value{font-size:1.75rem;font-weight:700;line-height:1}
    .kpi-card .kpi-label{color:#6c757d}
    .table thead th{white-space:nowrap}
    .sticky-actions{position:sticky; top:0; z-index:1; background:#fff; padding-top:.75rem}
  </style>
</head>
<body>

  <!-- Navbar (same as homepage) -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="{{ url_for('Home') }}">
        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo" class="navbar-logo">
        <div class="navbar-title">RGSQ</div>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
              aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="{{ url_for('Home') }}">Home</a></li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownSociety" role="button"
               data-bs-toggle="dropdown" aria-expanded="false">Society</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdownSociety">
              <a class="dropdown-item" href="Aboutsociety.html">About the society</a>
              <a class="dropdown-item" href="Governance.html">Governance</a>
              <a class="dropdown-item" href="Committees.html">Committees</a>
              <a class="dropdown-item" href="Honoursboard.html">Honours Board</a>
              <a class="dropdown-item" href="Donate.html">Donate</a>
            </div>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownEvent" role="button"
               data-bs-toggle="dropdown" aria-expanded="false">Event</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdownEvent">
              <a class="dropdown-item" href="{{ url_for('Eventlist') }}">Event List</a>
              <a class="dropdown-item" href="Disclaimer.html">Disclaimer</a>
            </div>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownProjects" role="button"
               data-bs-toggle="dropdown" aria-expanded="false">PROJECTS</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdownProjects">
              <a class="dropdown-item" href="AustraliaGeographyCompitions.html">Australia Geography Compitions</a>
              <a class="dropdown-item" href="Lambertcenter.html">Lambert center</a>
              <a class="dropdown-item" href="Queenslandbydegrees.html">Queensland by Degrees</a>
            </div>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownResources" role="button"
               data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">Resources</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdownResources">
              <a class="dropdown-item" href="Library.html">Library</a>
              <a class="dropdown-item" href="Venuehire.html">Venue Hire</a>
              <a class="dropdown-item" href="Bulletin.html">Bulletin</a>
              <div class="dropend">
                <a class="dropdown-item dropdown-toggle" href="#" id="collectionsMenu" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  Collections
                </a>
                <ul class="dropdown-menu" aria-labelledby="collectionsMenu">
                  <li><a class="dropdown-item" href="PhilateliesCover.html">Philatelies Cover</a></li>
                </ul>
              </div>
              <a class="dropdown-item" href="Geographywebsite.html">Geography website</a>
              <a class="dropdown-item" href="Museums and other attractions.html">Museums and other attractions</a>
              <a class="dropdown-item" href="MapResources.html">Map Resources</a>
            </div>
          </li>

                    <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button"
                         data-bs-toggle="dropdown" aria-expanded="false">
                        Membership
                      </a>
                      <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                        <a class="dropdown-item" href="Memberbenefits.html">Benefits</a>
                        <a class="dropdown-item" href="JoinRGSQ.html">Join RGSQ</a>
                        {% if is_admin %}
                          <a class="dropdown-item" href="{{ url_for('rgsq_staff_html') }}">RGSQ Staff</a>
                        {% endif %}
                      </div>
                    </li>

          <li class="nav-item"><a class="nav-link" href="Contact.html">Contact Us</a></li>
        </ul>

        <form class="d-flex" role="search">
          <input class="form-control me-2" type="search" placeholder="" aria-label="Search">
          <button class="btn btn-outline-success" type="submit">Search</button>
        </form>

        <ul class="navbar-nav">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownSetting" role="button"
               data-bs-toggle="dropdown" aria-expanded="false">Username</a>
            <div class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownSetting">
              <a class="dropdown-item" href="JoinRGSQ.html">Join RGSQ</a>
              <a class="dropdown-item" href="Login.html">Login</a>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Page header -->
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <h1 class="page-title m-0">Members Overview</h1>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb m-0">
          <li class="breadcrumb-item"><a href="RGSQStaff.html">RGSQ Staff</a></li>
          <li class="breadcrumb-item active" aria-current="page">Members Overview</li>
        </ol>
      </nav>
    </div>

    <!-- Filters -->
    <div class="row gy-2 align-items-end mt-3">
      <div class="col-12 col-md-3">
        <label class="form-label">Status</label>
        <select id="filterStatus" class="form-select">
          <option value="ALL" selected>All</option>
          <option value="Active">Active</option>
          <option value="Lapsed">Lapsed</option>
          <option value="Pending">Pending</option>
        </select>
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label">Time range</label>
        <select id="filterRange" class="form-select">
          <option value="30">Last 30 days</option>
          <option value="90">Last 90 days</option>
          <option value="365" selected>Last 12 months</option>
        </select>
      </div>
      <div class="col-12 col-md-6 text-md-end">
        <a href="RGSQStaff.html" class="btn btn-outline-secondary me-2">
          <i class="bi bi-arrow-left"></i> Back to Staff Dashboard
        </a>
        <button id="btnRefresh" class="btn btn-primary">
          <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="row g-3 mt-2">
      <div class="col-12 col-md-6 col-lg-3">
        <div class="card kpi-card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="kpi-value" id="kpiTotal">—</div>
                <div class="kpi-label">Total members</div>
              </div>
              <i class="bi bi-people fs-2 text-primary"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-lg-3">
        <div class="card kpi-card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="kpi-value" id="kpiActive">—</div>
                <div class="kpi-label">Active</div>
              </div>
              <i class="bi bi-check2-circle fs-2 text-success"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-lg-3">
        <div class="card kpi-card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="kpi-value" id="kpiNew">—</div>
                <div class="kpi-label">New this month</div>
              </div>
              <i class="bi bi-graph-up-arrow fs-2 text-info"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-lg-3">
        <div class="card kpi-card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="kpi-value" id="kpiChurn">—</div>
                <div class="kpi-label">Churn (30d)</div>
              </div>
              <i class="bi bi-exclamation-triangle fs-2 text-danger"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="row g-3 mt-1">
      <div class="col-12 col-lg-8">
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>New members (last 12 months)</span>
          </div>
          <div class="card-body">
            <canvas id="chartNewMembers" height="110"></canvas>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-4">
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Membership types</span>
          </div>
          <div class="card-body">
            <canvas id="chartTypes" height="110"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent members -->
    <div class="row g-3 mt-1">
      <div class="col-12">
        <div class="card">
          <div class="card-header sticky-actions">
            <div class="row g-2 align-items-center">
              <div class="col-12 col-md-6">
                <strong>Recent members</strong>
              </div>
              <div class="col-8 col-md-4">
                <input id="searchInput" class="form-control" placeholder="Search by name or email">
              </div>
              <div class="col-4 col-md-2 text-end">
                <button id="btnExport" class="btn btn-outline-secondary btn-sm">
                  <i class="bi bi-download"></i> Export CSV
                </button>
              </div>
            </div>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Status</th>
                    <th>Type</th>
                    <th>Joined</th>
                    <th>Renewal</th>
                    <th>City</th>
                  </tr>
                </thead>
                <tbody id="membersTbody">
                  <!-- rows injected by JS -->
                </tbody>
              </table>
            </div>
          </div>
          <div class="card-footer small text-muted">
            Demo data only. Hook to your database/API later.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JS: Bootstrap + Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
          crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    // -------- Demo dataset (replace with real API later) --------
    const members = [
      {name:"Alex Johnson",  email:"alex.johnson@example.com",  status:"Active",  type:"Full",     joined:"2024-11-12", renewal:"2025-11-12", city:"Brisbane"},
      {name:"Bethany Lee",   email:"bethany.lee@example.com",   status:"Active",  type:"Student",  joined:"2025-02-03", renewal:"2026-02-03", city:"Brisbane"},
      {name:"Chris Walker",  email:"chris.walker@example.com",  status:"Lapsed",  type:"Full",     joined:"2023-09-20", renewal:"2024-09-20", city:"Gold Coast"},
      {name:"Dylan Smith",   email:"dylan.smith@example.com",   status:"Active",  type:"Full",     joined:"2025-05-18", renewal:"2026-05-18", city:"Sunshine Coast"},
      {name:"Emma Davis",    email:"emma.davis@example.com",    status:"Pending", type:"Full",     joined:"2025-06-22", renewal:"2026-06-22", city:"Brisbane"},
      {name:"Frank Moore",   email:"frank.moore@example.com",   status:"Active",  type:"Honorary", joined:"2022-06-01", renewal:"—",         city:"Townsville"},
      {name:"Grace Parker",  email:"grace.parker@example.com",  status:"Active",  type:"Full",     joined:"2025-07-01", renewal:"2026-07-01", city:"Brisbane"},
      {name:"Henry Brown",   email:"henry.brown@example.com",   status:"Lapsed",  type:"Student",  joined:"2024-03-10", renewal:"2025-03-10", city:"Cairns"},
      {name:"Isla Nguyen",   email:"isla.nguyen@example.com",   status:"Active",  type:"Full",     joined:"2025-07-15", renewal:"2026-07-15", city:"Brisbane"},
      {name:"Jack Wilson",   email:"jack.wilson@example.com",   status:"Active",  type:"Full",     joined:"2025-01-22", renewal:"2026-01-22", city:"Ipswich"},
      {name:"Karen Green",   email:"karen.green@example.com",   status:"Active",  type:"Student",  joined:"2025-03-02", renewal:"2026-03-02", city:"Brisbane"},
      {name:"Leo Martinez",  email:"leo.martinez@example.com",  status:"Pending", type:"Full",     joined:"2025-07-28", renewal:"2026-07-28", city:"Brisbane"}
    ];

    // ------- Utilities -------
    const parseDate = s => s === "—" ? null : new Date(s+"T00:00:00");
    function withinDays(date, days){
      if(!date) return false;
      const now = new Date();
      const diff = (now - date) / (1000*60*60*24);
      return diff <= days && diff >= 0;
    }
    function monthKey(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`; }

    // ------- Render table -------
    const tbody = document.getElementById("membersTbody");
    function renderTable(list){
      tbody.innerHTML = "";
      list.forEach(m=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${m.name}</td>
          <td>${m.email}</td>
          <td><span class="badge ${m.status==='Active'?'bg-success':(m.status==='Lapsed'?'bg-secondary':'bg-warning text-dark')}">${m.status}</span></td>
          <td>${m.type}</td>
          <td>${m.joined}</td>
          <td>${m.renewal}</td>
          <td>${m.city}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ------- KPIs -------
    function computeKPIs(list){
      const total = list.length;
      const active = list.filter(m=>m.status==="Active").length;

      const now = new Date();
      const newThisMonth = list.filter(m=>{
        const d = parseDate(m.joined);
        return d && d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear();
      }).length;

      const churn30 = list.filter(m=>{
        if(m.status!=="Lapsed") return false;
        const d = parseDate(m.renewal);
        // assume lapsed when renewal date passed; for demo: lapsed within 30d
        return d && withinDays(d, 30);
      }).length;

      document.getElementById("kpiTotal").textContent = total;
      document.getElementById("kpiActive").textContent = active;
      document.getElementById("kpiNew").textContent = newThisMonth;
      document.getElementById("kpiChurn").textContent = churn30;
    }

    // ------- Charts -------
    const ctxLine = document.getElementById("chartNewMembers");
    const ctxPie  = document.getElementById("chartTypes");
    let lineChart, pieChart;

    function buildLineData(list){
      // last 12 months buckets
      const now = new Date();
      const labels = [];
      const buckets = {};
      for(let i=11;i>=0;i--){
        const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
        const key = monthKey(d);
        labels.push(d.toLocaleString("en-US",{month:"short", year:"2-digit"}));
        buckets[key]=0;
      }
      list.forEach(m=>{
        const d = parseDate(m.joined);
        if(!d) return;
        const key = monthKey(new Date(d.getFullYear(), d.getMonth(), 1));
        if(key in buckets) buckets[key]++;
      });
      const data = Object.values(buckets);
      return {labels, data};
    }

    function buildPieData(list){
      const counts = {};
      list.forEach(m=>{ counts[m.type]=(counts[m.type]||0)+1; });
      const labels = Object.keys(counts);
      const data = Object.values(counts);
      return {labels,data};
    }

    function renderCharts(list){
      const L = buildLineData(list);
      if(lineChart) lineChart.destroy();
      lineChart = new Chart(ctxLine, {
        type: 'line',
        data: {
          labels: L.labels,
          datasets: [{ label:'New members', data: L.data, tension: .25 }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display:false } },
          scales: { y: { beginAtZero:true, ticks:{ precision:0 } } }
        }
      });

      const P = buildPieData(list);
      if(pieChart) pieChart.destroy();
      pieChart = new Chart(ctxPie, {
        type: 'doughnut',
        data: {
          labels: P.labels,
          datasets: [{ data: P.data }]
        },
        options: { plugins: { legend: { position:'bottom' } } }
      });
    }

    // ------- Filters & Search -------
    function applyFilters(){
      const status = document.getElementById("filterStatus").value; // ALL/Active/Lapsed/Pending
      const days = parseInt(document.getElementById("filterRange").value,10); // 30/90/365
      const now = new Date();

      return members.filter(m=>{
        const sOk = (status==="ALL") ? true : (m.status===status);
        const d = parseDate(m.joined);
        const inRange = d ? ((now - d)/(1000*60*60*24) <= days) : true;
        return sOk && inRange;
      });
    }

    function applySearch(list){
      const q = document.getElementById("searchInput").value.trim().toLowerCase();
      if(!q) return list;
      return list.filter(m =>
        m.name.toLowerCase().includes(q) || m.email.toLowerCase().includes(q)
      );
    }

    function refreshAll(){
      let list = applyFilters();
      list = applySearch(list);
      renderTable(list);
      computeKPIs(list);
      renderCharts(list);
    }

    document.getElementById("filterStatus").addEventListener("change", refreshAll);
    document.getElementById("filterRange").addEventListener("change", refreshAll);
    document.getElementById("btnRefresh").addEventListener("click", refreshAll);
    document.getElementById("searchInput").addEventListener("input", refreshAll);

    // ------- Export CSV -------
    document.getElementById("btnExport").addEventListener("click", ()=>{
      let list = applyFilters();
      list = applySearch(list);
      const header = ["Name","Email","Status","Type","Joined","Renewal","City"];
      const rows = list.map(m=>[m.name,m.email,m.status,m.type,m.joined,m.renewal,m.city]);
      const csv = [header, ...rows].map(r=>r.map(x => `"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "members_overview.csv";
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    // Initial paint
    refreshAll();
  </script>
</body>
</html>
